# Бизнес-логика системы

## 1. Общая концепция

AI Content Generator — платформа для генерации различных типов контента с использованием искусственного интеллекта. МВП фокусируется на генерации инфографики через Gemini API с расширяемой архитектурой для добавления новых AI-сервисов.

### Ключевые принципы
- **Модульность:** легкое добавление новых типов генераторов
- **Масштабируемость:** готовность к росту нагрузки
- **Прозрачность:** понятная система балансов и тарификации
- **Безопасность:** контроль контента и защита данных пользователей

---

## 2. Пользователи и аутентификация

### 2.1 Регистрация

**Процесс:**
1. Пользователь заполняет форму (email + пароль)
2. Валидация данных:
   - Email уникальный и валидный
   - Пароль минимум 8 символов
3. Создание аккаунта
4. Автоматическое создание баланса (1000 кредитов)
5. Опционально: отправка письма для верификации email

**Бизнес-правила:**
- Один email = один аккаунт
- Начальный бонус: 1000 кредитов
- Email verification опционально для МВП

### 2.2 Авторизация

**Процесс:**
1. Вход по email + пароль
2. Опция "Запомнить меня" (30 дней)
3. Создание сессии
4. Редирект в личный кабинет

**Бизнес-правила:**
- Максимум 5 неудачных попыток входа за 5 минут (rate limiting)
- Сессия истекает через 2 часа неактивности (настраивается)

### 2.3 Восстановление пароля

**Процесс:**
1. Запрос на восстановление по email
2. Генерация токена (срок действия 1 час)
3. Отправка письма со ссылкой
4. Переход по ссылке
5. Установка нового пароля
6. Автоматический вход

**Бизнес-правила:**
- Токен действителен 1 час
- После установки нового пароля старые токены недействительны
- Максимум 3 запроса на восстановление в час

---

## 3. Система балансов

### 3.1 Начисление кредитов

**При регистрации:**
- Каждый новый пользователь получает **1000 кредитов**
- Начисление происходит автоматически при создании аккаунта

**В МВП не реализовано:**
- Пополнение баланса
- Покупка кредитов
- Промокоды и скидки

**После МВП:**
- Интеграция платежных систем (Stripe, PayPal)
- Пакеты кредитов с разными ценами
- Подписки

### 3.2 Списание кредитов

**Тарификация генерации:**
- **Инфографика:** 10 кредитов (настраивается в конфиге)

**Процесс списания:**
1. Проверка достаточности баланса **до** генерации
2. Если баланса недостаточно → ошибка
3. Генерация контента
4. При успешной генерации → списание кредитов
5. При ошибке генерации → кредиты **не списываются**

**Бизнес-правила:**
- Списание только за успешные генерации
- Транзакция списания сохраняется в `balance_transactions`
- Невозможно уйти в минус

### 3.3 Отображение баланса

**Где отображается:**
- Личный кабинет (основная информация)
- Шапка сайта (после авторизации)
- Перед генерацией (предупреждение о стоимости)

**Формат:**
- "У вас: 1000 кредитов"
- "Стоимость генерации: 10 кредитов"

---

## 4. Генерация инфографики

### 4.1 Workflow генерации

```
1. Пользователь вводит промт (текстовое описание)
   ↓
2. Валидация:
   - Промт не пустой
   - Длина <= 1000 символов
   - Пользователь авторизован
   ↓
3. Проверка баланса:
   - Если < 10 кредитов → ошибка "Недостаточно средств"
   ↓
4. Отправка запроса к Gemini API
   - Timeout: 60 секунд
   - Retry при сетевых ошибках (опционально)
   ↓
5. Получение результата (изображение)
   ↓
6. Сохранение в storage:
   - Генерация уникального имени файла
   - Сохранение в private storage
   ↓
7. Сохранение в БД:
   - Создание записи в `generations`
   - Создание записи в `infographics`
   - Генерация UUID для публичной ссылки
   ↓
8. Списание кредитов:
   - Обновление баланса
   - Создание транзакции
   ↓
9. Возврат результата пользователю
```

### 4.2 Обработка ошибок

**Типы ошибок:**

1. **Недостаточно кредитов:**
   - Сообщение: "Недостаточно кредитов. Требуется: 10, у вас: {balance}"
   - Кредиты НЕ списываются
   - Генерация НЕ создается

2. **Ошибка API (Gemini):**
   - Rate limit: "Превышен лимит запросов, попробуйте позже"
   - Invalid key: "Ошибка конфигурации, обратитесь к администратору"
   - Timeout: "Превышено время ожидания, попробуйте еще раз"
   - Кредиты НЕ списываются
   - Запись в БД создается со статусом `failed`

3. **Сетевые ошибки:**
   - Сообщение: "Ошибка соединения, попробуйте позже"
   - Кредиты НЕ списываются

4. **Ошибки валидации:**
   - Промт слишком длинный: "Максимальная длина промта: 1000 символов"
   - Пустой промт: "Введите описание для генерации"

**Логирование:**
- Все ошибки API логируются в `storage/logs/laravel.log`
- Сохраняется `error_message` в таблице `generations`

### 4.3 Статусы генерации

**Возможные статусы:**
- `pending` — создана, ожидает обработки (для очередей)
- `processing` — в процессе генерации
- `completed` — успешно завершена
- `failed` — ошибка генерации

**В МВП:**
- Генерация синхронная, статус сразу `completed` или `failed`
- Статусы `pending`/`processing` используются после добавления очередей

---

## 5. История генераций

### 5.1 Отображение истории

**Список генераций:**
- Сортировка: от новых к старым
- Пагинация: 20 элементов на страницу
- Для каждой генерации отображается:
  - Thumbnail изображения (150x150px)
  - Промт (обрезка до 100 символов)
  - Дата создания (относительная: "2 часа назад")
  - Статус (иконка: успех/ошибка)

**Фильтрация (после МВП):**
- По статусу (успешные/ошибки)
- По дате
- Поиск по промту

### 5.2 Детальный просмотр

**Страница генерации:**
- Полноразмерное изображение
- Полный промт
- Дата и время создания
- Стоимость генерации
- Кнопки действий:
  - Скачать
  - Поделиться (копирование публичной ссылки)
  - Удалить из истории

### 5.3 Удаление генераций

**Процесс:**
1. Подтверждение действия (JS confirm)
2. Удаление записи из БД (soft delete или hard delete)
3. Опционально: удаление файла из storage

**Бизнес-правила:**
- Кредиты НЕ возвращаются при удалении
- Публичная ссылка становится недоступна
- Удаление мгновенное (без очередей в МВП)

---

## 6. Публичные ссылки

### 6.1 Генерация ссылок

**Процесс:**
1. При создании генерации автоматически создается UUID
2. Ссылка формируется: `/share/{uuid}`
3. Пользователь копирует ссылку через кнопку "Поделиться"

**Формат UUID:**
- `https://generator.local/share/550e8400-e29b-41d4-a716-446655440000`

### 6.2 Доступ к публичным ссылкам

**Открытый доступ:**
- Не требуется авторизация
- Любой пользователь может просмотреть
- Отображается только изображение
- **НЕ** отображается промт (конфиденциальность)

**Водяной знак (опционально):**
- Логотип сервиса в углу изображения
- Реализуется после МВП

**Статистика (после МВП):**
- Счетчик просмотров
- География просмотров
- Реферреры

---

## 7. Личный кабинет

### 7.1 Профиль пользователя

**Информация:**
- Email (не редактируется)
- Дата регистрации
- Текущий баланс кредитов

**Действия:**
- Изменение пароля
- Выход из аккаунта

### 7.2 Изменение пароля

**Процесс:**
1. Ввод текущего пароля
2. Ввод нового пароля
3. Подтверждение нового пароля
4. Валидация:
   - Текущий пароль верный
   - Новый пароль минимум 8 символов
   - Пароли совпадают
5. Обновление пароля
6. Завершение всех активных сессий (кроме текущей)

---

## 8. Модерация (заглушка в МВП)

### 8.1 Текущая реализация

**В МВП:**
- Поле `moderation_status` в таблице `generations`
- Все генерации автоматически получают статус `approved`
- Базовая админка для просмотра генераций
- Ручное изменение статуса (через БД или админку)

**Статусы модерации:**
- `pending` — ожидает проверки
- `approved` — одобрено (по умолчанию в МВП)
- `rejected` — отклонено

### 8.2 После МВП

**Планируется:**
- Автоматическая модерация через AI (определение неприемлемого контента)
- Очередь на модерацию
- Админ-панель для модераторов
- Уведомления пользователей при отклонении
- Возврат кредитов при отклонении (опционально)

---

## 9. Безопасность и ограничения

### 9.1 Rate Limiting

**Генерация инфографики:**
- Максимум **10 запросов в минуту** на пользователя
- При превышении: HTTP 429 "Too Many Requests"
- Сообщение: "Превышен лимит запросов, подождите {seconds} секунд"

**Авторизация:**
- Максимум **5 попыток входа за 5 минут**
- При превышении: блокировка на 15 минут

**Восстановление пароля:**
- Максимум **3 запроса в час**

### 9.2 Валидация контента

**Промты:**
- Максимальная длина: 1000 символов
- Санитизация HTML (strip_tags)
- Проверка на SQL injection (через ORM)

**Публичные ссылки:**
- UUID валидация (формат)
- Проверка существования

### 9.3 Приватность

**Файлы:**
- Хранятся в private storage
- Доступ только через контроллеры
- Проверка прав доступа (владелец или публичная ссылка)

**Данные пользователей:**
- Пароли: bcrypt хэш
- API ключи: только в `.env`, не в коде
- Промты: доступны только владельцу

---

## 10. Архитектура AI-сервисов

### 10.1 Паттерн Factory

**Интерфейс AIServiceInterface:**
```php
interface AIServiceInterface
{
    public function generate(string $prompt, array $options = []): mixed;
    public function getServiceType(): string;
    public function getCost(): int;
}
```

**Factory:**
```php
class AIServiceFactory
{
    public static function make(string $type): AIServiceInterface
    {
        return match($type) {
            'infographic' => new InfographicGenerator(),
            'text' => new TextGenerator(),
            'description' => new DescriptionGenerator(),
            default => throw new InvalidArgumentException()
        };
    }
}
```

### 10.2 Добавление новых сервисов

**Процесс:**
1. Создать класс генератора (implements AIServiceInterface)
2. Добавить в Factory
3. Создать контроллер для нового типа
4. Добавить маршруты
5. Создать views

**Пример:**
- `TextGenerator` — генерация текста
- `DescriptionGenerator` — генерация описаний продуктов
- `LogoGenerator` — генерация логотипов

### 10.3 GeminiService

**Основной метод:**
```php
public function generateImage(string $prompt): string
{
    // 1. Подготовка запроса
    // 2. Отправка к API
    // 3. Обработка ответа
    // 4. Возврат изображения (base64 или URL)
}
```

**Конфигурация:**
- API ключ: `config('services.gemini.api_key')`
- Endpoint: `config('services.gemini.endpoint')`
- Timeout: 60 секунд
- Retry: 1 попытка при сетевой ошибке

---

## 11. Расширяемость (после МВП)

### 11.1 Система очередей

**Асинхронная генерация:**
1. Запрос создается со статусом `pending`
2. Job добавляется в очередь Redis
3. Worker обрабатывает Job
4. Статус обновляется на `processing` → `completed`/`failed`
5. Уведомление пользователю (email/websocket)

**Преимущества:**
- Нет timeout на фронтенде
- Масштабируемость (несколько workers)
- Retry механизм при ошибках

### 11.2 Платежная система

**Интеграция:**
- Stripe или PayPal
- Пакеты кредитов: 1000, 5000, 10000
- Подписки: ежемесячные кредиты

**Процесс:**
1. Выбор пакета
2. Оплата через Stripe
3. Webhook от Stripe
4. Начисление кредитов
5. Email подтверждение

### 11.3 Расширенная модерация

**AI-модерация:**
- Автоматическая проверка контента
- Определение NSFW
- Определение насилия, оружия
- Статус `pending` → автоматическая проверка → `approved`/`rejected`

**Ручная модерация:**
- Админ-панель для модераторов
- Очередь на проверку
- История решений
