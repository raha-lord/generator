# План разработки МВП

## Общая информация

**Срок разработки:** 19-30 дней (зависит от опыта разработчика)

**Цель МВП:** Запустить работающую платформу с базовым функционалом генерации инфографики через Gemini API.

---

## Этап 1: Базовая инфраструктура (3-5 дней)

### Задачи

- [ ] **Создание Laravel проекта**
  - Установка Laravel 11.x
  - Настройка `.env`
  - Инициализация Git репозитория

- [ ] **Docker setup**
  - Создание `docker-compose.yml`
  - Настройка сервисов: app, nginx, postgres, redis, minio
  - Проверка работоспособности контейнеров
  - Настройка volumes для persistence

- [ ] **Миграции БД**
  - Создание миграции для `users`
  - Создание миграции для `balances`
  - Создание миграции для `generations`
  - Создание миграции для `infographics`
  - Создание миграции для `balance_transactions`
  - Создание миграции для `password_reset_tokens`
  - Выполнение миграций

- [ ] **Модели + relationships**
  - Модель `User` с relationships
  - Модель `Balance` с relationships
  - Модель `Generation` (полиморфная)
  - Модель `Infographic`
  - Модель `BalanceTransaction`
  - Настройка Eloquent relationships

- [ ] **Seeders (тестовые данные)**
  - UserSeeder — 10 тестовых пользователей
  - BalanceSeeder — балансы для пользователей
  - GenerationSeeder — 50 тестовых генераций
  - DatabaseSeeder — объединение всех seeders

### Результат этапа

✅ Работающий Docker-окружение
✅ База данных с миграциями
✅ Модели с корректными связями
✅ Тестовые данные для разработки

---

## Этап 2: Аутентификация (2-3 дня)

### Задачи

- [ ] **Регистрация/вход**
  - Установка Laravel Breeze (или ручная реализация)
  - Форма регистрации (name, email, password)
  - Валидация регистрации
  - Хэширование паролей (bcrypt)
  - Создание баланса при регистрации (observer/event)
  - Форма входа
  - "Запомнить меня" функционал
  - Logout

- [ ] **Восстановление пароля**
  - Форма "Забыли пароль?"
  - Отправка email с токеном
  - Настройка Mail (Mailhog для dev)
  - Форма сброса пароля
  - Валидация токена (срок 1 час)
  - Обновление пароля

- [ ] **Middleware для защиты роутов**
  - `auth` middleware для закрытых страниц
  - `guest` middleware для страниц входа/регистрации
  - Редиректы при неавторизованном доступе

### Результат этапа

✅ Регистрация и вход работают
✅ Восстановление пароля функционирует
✅ Защищенные роуты недоступны без авторизации

---

## Этап 3: Система балансов (1-2 дня)

### Задачи

- [ ] **BalanceService**
  - Метод `getBalance(User $user): int`
  - Метод `hasEnoughCredits(User $user, int $amount): bool`
  - Метод `deductCredits(User $user, int $amount, string $description, ?Generation $generation): void`
  - Метод `addCredits(User $user, int $amount, string $description): void`
  - Обработка ошибок (InsufficientBalanceException)

- [ ] **Логика начисления при регистрации**
  - Observer или Event для User
  - Автоматическое создание Balance с 1000 кредитов
  - Тест на корректность начисления

- [ ] **Проверка/списание кредитов**
  - Middleware `CheckBalance` (опционально)
  - Интеграция в контроллер генерации
  - Создание транзакции при списании
  - Unit тесты для BalanceService

### Результат этапа

✅ Баланс создается при регистрации
✅ Списание кредитов работает корректно
✅ Транзакции сохраняются в БД

---

## Этап 4: AI Services архитектура (2-3 дня)

### Задачи

- [ ] **AIServiceInterface**
  - Создание интерфейса с методами:
    - `generate(string $prompt, array $options = []): mixed`
    - `getServiceType(): string`
    - `getCost(): int`

- [ ] **AIServiceFactory**
  - Реализация паттерна Factory
  - Метод `make(string $type): AIServiceInterface`
  - Обработка неизвестных типов (exception)

- [ ] **GeminiService (интеграция)**
  - HTTP клиент для Gemini API (Guzzle)
  - Метод `generateImage(string $prompt): string`
  - Обработка ответа API (base64/URL)
  - Обработка ошибок (timeout, rate limit, invalid key)
  - Конфигурация в `config/services.php`
  - `.env` переменная `GEMINI_API_KEY`

- [ ] **InfographicGenerator**
  - Реализация `AIServiceInterface`
  - Использование `GeminiService`
  - Метод `generate()` возвращает путь к файлу
  - Стоимость: 10 кредитов

- [ ] **Заглушки для TextGenerator, DescriptionGenerator**
  - Классы с минимальной реализацией
  - Возвращают статичные данные
  - Готовы для будущей интеграции

### Результат этапа

✅ Интерфейс и Factory работают
✅ Gemini API интеграция функционирует
✅ InfographicGenerator генерирует изображения
✅ Архитектура готова к расширению

---

## Этап 5: Генерация инфографики (3-4 дня)

### Задачи

- [ ] **InfographicController**
  - Метод `create()` — форма генерации
  - Метод `store(GenerateInfographicRequest $request)` — обработка запроса
  - Метод `show(Generation $generation)` — просмотр результата
  - Проверка прав доступа (policy)

- [ ] **Форма генерации (Blade + JS)**
  - Textarea для промта (max 1000 символов)
  - Счетчик символов (JS)
  - Отображение текущего баланса
  - Стоимость генерации
  - Кнопка "Создать инфографику"
  - Loader/спиннер во время генерации

- [ ] **Обработка запроса**
  - Валидация промта (GenerateInfographicRequest)
  - Проверка баланса
  - Вызов AIServiceFactory
  - Сохранение изображения через StorageService
  - Создание записей в БД (Generation + Infographic)
  - Генерация UUID для публичной ссылки
  - Списание кредитов через BalanceService
  - Обработка ошибок (try-catch)

- [ ] **Сохранение в storage**
  - StorageService для работы с файлами
  - Генерация уникальных имен файлов
  - Сохранение в `storage/app/private/generations/`
  - Получение metadata (размер, разрешение)

- [ ] **Отображение результата**
  - AJAX ответ с данными генерации
  - Отображение изображения под формой
  - Обновление баланса в UI
  - Сообщения об ошибках (toast/alert)
  - Кнопки: "Скачать", "Поделиться", "Создать еще"

### Результат этапа

✅ Генерация инфографики работает end-to-end
✅ Изображения сохраняются корректно
✅ Баланс списывается
✅ Ошибки обрабатываются

---

## Этап 6: История и публичные ссылки (2-3 дня)

### Задачи

- [ ] **Страница истории**
  - GenerationHistoryController
  - Метод `index()` — список генераций пользователя
  - Пагинация (20 элементов)
  - Сортировка от новых к старым
  - Blade view с grid/list layout

- [ ] **Просмотр деталей генерации**
  - Метод `show(Generation $generation)`
  - Policy для проверки прав (только владелец)
  - Полноразмерное изображение
  - Полный промт
  - Дата создания
  - Кнопки: Скачать, Поделиться, Удалить

- [ ] **Генерация UUID**
  - Автоматическая генерация при создании Generation
  - Migration с `uuid` полем (unique)
  - Использование `Str::uuid()` или DB функции

- [ ] **Публичный просмотр**
  - Роут `/share/{uuid}`
  - ShareController
  - Поиск генерации по UUID
  - Отображение только изображения (БЕЗ промта)
  - Публичный layout (без авторизации)

- [ ] **Кнопка "Поделиться"**
  - Копирование ссылки в буфер обмена (JS)
  - Toast уведомление "Ссылка скопирована"
  - Опционально: QR-код для ссылки

### Результат этапа

✅ История генераций доступна
✅ Публичные ссылки работают
✅ Кнопка "Поделиться" копирует ссылку
✅ Детальный просмотр функционирует

---

## Этап 7: Личный кабинет (1-2 дня)

### Задачи

- [ ] **Страница профиля**
  - ProfileController
  - Метод `show()` — отображение профиля
  - Blade view с информацией

- [ ] **Отображение баланса**
  - Текущий баланс кредитов
  - История последних транзакций (5-10 записей)
  - Ссылка на полную историю транзакций

- [ ] **Изменение пароля**
  - Форма изменения пароля
  - Метод `updatePassword(Request $request)`
  - Валидация:
    - Текущий пароль верный
    - Новый пароль минимум 8 символов
    - Подтверждение совпадает
  - Завершение других сессий (опционально)
  - Уведомление об успешном изменении

### Результат этапа

✅ Личный кабинет доступен
✅ Баланс отображается
✅ Изменение пароля работает

---

## Этап 8: UI/UX полировка (2-3 дня)

### Задачи

- [ ] **Дизайн всех страниц**
  - Главная страница с описанием сервиса
  - Call-to-Action кнопки
  - Страницы аутентификации (единый стиль)
  - Страница генерации (user-friendly)
  - История генераций (grid/list toggle)
  - Профиль

- [ ] **Адаптивность**
  - Mobile-first подход
  - Тестирование на разных разрешениях:
    - Desktop (1920x1080)
    - Tablet (768x1024)
    - Mobile (375x667)
  - Адаптивное меню (hamburger на mobile)

- [ ] **Сообщения об ошибках**
  - Красивые alert/toast уведомления
  - Валидационные ошибки под полями
  - Информационные сообщения (успех)
  - 404/500 страницы с дизайном

- [ ] **Loader/спиннеры**
  - Spinner при генерации
  - Skeleton loaders для истории
  - Progress bar (опционально)
  - Disable кнопок во время загрузки

### Результат этапа

✅ Все страницы имеют единый дизайн
✅ Сайт адаптивен на всех устройствах
✅ UX интуитивен
✅ Ошибки отображаются понятно

---

## Этап 9: Тестирование и баги (2-3 дня)

### Задачи

- [ ] **Unit tests**
  - BalanceService тесты:
    - Списание кредитов
    - Проверка баланса
    - Обработка недостаточного баланса
  - AIServiceFactory тесты:
    - Создание сервисов
    - Обработка неизвестных типов
  - Models тесты:
    - Relationships
    - Scopes
    - Mutators/Accessors

- [ ] **Feature tests**
  - Регистрация:
    - Успешная регистрация
    - Валидация (дубль email, короткий пароль)
    - Создание баланса
  - Авторизация:
    - Успешный вход
    - Неверные credentials
    - Rate limiting
  - Генерация инфографики:
    - Успешная генерация (мокирование API)
    - Недостаточно баланса
    - Валидация промта
    - Списание кредитов
  - Публичные ссылки:
    - Доступность по UUID
    - 404 для несуществующих

- [ ] **Manual testing**
  - End-to-end флоу:
    1. Регистрация
    2. Генерация инфографики
    3. Просмотр истории
    4. Публичная ссылка
    5. Изменение пароля
    6. Logout
  - Проверка UI на разных браузерах (Chrome, Firefox, Safari)
  - Тестирование ошибок API (отключение Gemini, неверный ключ)

- [ ] **Фикс багов**
  - Исправление найденных ошибок
  - Regression testing
  - Code review
  - Рефакторинг (по необходимости)

### Результат этапа

✅ 80%+ покрытие тестами
✅ Все критические баги исправлены
✅ End-to-end флоу работает без ошибок

---

## Этап 10: Deployment (1-2 дня)

### Задачи

- [ ] **Настройка production окружения**
  - Настройка `.env` для production
  - `APP_ENV=production`
  - `APP_DEBUG=false`
  - Генерация `APP_KEY`
  - Настройка БД (production PostgreSQL)
  - Настройка Redis
  - Настройка S3 (или MinIO)

- [ ] **Деплой на хост**
  - Выбор хостинга (DigitalOcean, AWS, Hetzner, etc.)
  - Настройка сервера (nginx, supervisor)
  - Docker Compose на production
  - SSL сертификат (Let's Encrypt)
  - Настройка domain
  - Запуск миграций
  - Запуск seeders (если нужно)

- [ ] **Проверка работоспособности**
  - Тестирование всех функций на production
  - Проверка email отправки
  - Проверка Gemini API
  - Проверка storage (загрузка/скачивание)
  - Мониторинг логов
  - Backup БД

### Результат этапа

✅ Приложение развернуто на production
✅ Все функции работают
✅ SSL настроен
✅ Мониторинг запущен

---

## Критерии приемки МВП

### Обязательные требования

- [x] **Регистрация/вход**
  - Пользователь может зарегистрироваться
  - Пользователь может войти
  - Восстановление пароля работает

- [x] **Баланс**
  - При регистрации начисляется 1000 кредитов
  - Баланс отображается в личном кабинете
  - Баланс корректно списывается

- [x] **Генерация инфографики**
  - Пользователь может ввести промт
  - Генерация запускается
  - Изображение отображается
  - Кредиты списываются

- [x] **История**
  - Все генерации сохраняются
  - Пользователь видит свою историю
  - Можно просмотреть детали

- [x] **Публичные ссылки**
  - У каждой генерации есть UUID
  - Ссылка работает без авторизации
  - Промт НЕ отображается

- [x] **Производительность**
  - Время генерации < 60 секунд
  - Страницы загружаются < 2 секунд

- [x] **Безопасность**
  - Нет критических уязвимостей
  - CSRF protection включена
  - Пароли захэшированы

### Опциональные улучшения (Nice to have)

- [ ] Email verification при регистрации
- [ ] Фильтры в истории генераций
- [ ] Водяной знак на публичных изображениях
- [ ] Dark mode
- [ ] Экспорт истории (CSV)
- [ ] WebSocket для real-time статусов

---

## Метрики успеха

### После запуска МВП нужно отслеживать:

1. **Пользователи:**
   - Количество регистраций
   - Daily Active Users (DAU)
   - Retention rate (день 1, день 7, день 30)

2. **Генерации:**
   - Количество генераций в день
   - Успешность генераций (% completed)
   - Средняя длина промта
   - Время генерации

3. **Технические:**
   - Uptime (цель: 99%+)
   - Средний response time
   - Количество ошибок API
   - Использование storage

4. **Бизнес:**
   - Средний баланс пользователя
   - Скорость расхода кредитов
   - Конверсия в регистрацию

---

## Риски и митигации

### Риск 1: Gemini API не работает стабильно

**Митигация:**
- Реализовать retry логику
- Добавить fallback на другой API (Stable Diffusion, DALL-E)
- Очереди для асинхронной обработки

### Риск 2: Превышение бюджета на API запросы

**Митигация:**
- Rate limiting на пользователя
- Мониторинг использования API
- Кэширование похожих промтов (после МВП)

### Риск 3: Проблемы с производительностью при росте

**Митигация:**
- Горизонтальное масштабирование (Docker Swarm/Kubernetes)
- CDN для статики
- Database indexing и оптимизация

### Риск 4: Задержка в разработке

**Митигация:**
- Agile подход (спринты по 3-5 дней)
- Приоритизация функционала (MVP first)
- Code review для качества

---

## Дальнейшее развитие (Post-MVP)

### Фаза 2 (после успешного запуска МВП):

1. **Очереди для генерации**
   - Асинхронная обработка
   - Laravel Horizon
   - Email/WebSocket уведомления

2. **Платежная система**
   - Stripe интеграция
   - Пакеты кредитов
   - Подписки

3. **Модерация с AI**
   - Автоматическая проверка контента
   - NSFW фильтр
   - Админ-панель для модераторов

4. **Новые типы генерации**
   - TextGenerator
   - DescriptionGenerator
   - LogoGenerator

### Фаза 3 (масштабирование):

1. **Публичный API**
   - REST API для внешних клиентов
   - API ключи
   - Rate limiting
   - Документация (Swagger)

2. **Аналитика**
   - Dashboard для пользователей
   - Статистика генераций
   - A/B тестирование

3. **Мобильное приложение**
   - React Native или Flutter
   - Использование REST API

---

## Заключение

План разработки рассчитан на **19-30 дней** с учетом всех этапов. При наличии опыта с Laravel и Docker можно уложиться в нижнюю границу.

**Ключевые моменты:**
- Модульная архитектура позволит легко расширять функционал
- Тестирование критично для стабильности
- UI/UX полировка важна для пользовательского опыта
- Production deployment должен быть тщательно протестирован

**Следующие шаги:**
1. Review плана с командой
2. Настройка рабочего окружения
3. Старт разработки с этапа 1
